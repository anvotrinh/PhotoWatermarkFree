fastlane_require 'dotenv'

before_all do
  Dotenv.overload '.env.secret'
end

lane :internal do
  changeEnv('staging')
  versionName, versionCode = increaseVersionCode
  gradle(task: 'clean')
  gradle(task: 'bundle', build_type: 'Release')
  upload_to_play_store(
    track: 'internal',
    skip_upload_apk: true
  )
  notifySlack(versionName, versionCode)
end

lane :release do
  changeEnv('production')
  versionName, versionCode = increaseVersionCode
  gradle(task: 'clean')
  gradle(task: 'bundle', build_type: 'Release')
  upload_to_play_store(
    track: 'production',
    skip_upload_apk: true
  )
  changeEnv('staging')
end

def increaseVersionCode()
  ensure_git_status_clean

  # read file
  path = '../app/build.gradle'
  s = File.read(path)
  # get version name
  re = /versionName\s+"([\d.]+)"/ 
  m = s.match(re)
  versionName = ''
  if m
    versionName = m[1]
  end
  # update version code
  productionCode = google_play_track_version_codes(track: 'production')
  internalCode = google_play_track_version_codes(track: 'internal')
  versionCode = ([productionCode[0], internalCode[0]].max + 1).to_s

  re = /versionCode\s+(\d+)/ 
  s = s.sub(re, "versionCode #{versionCode}")
  # save to file
  f = File.new(path, 'w')
  f.write(s)
  f.close
  # commit
  git_commit(
    path: 'app/build.gradle',
    message: "increase Android version code #{versionCode}"
  )
  push_to_git_remote(remote_branch: 'master')
  return versionName, versionCode
end

def notifySlack(versionName, versionCode)
  message = "New internal version #{versionName} (#{versionCode}) of Park Smart Android has been deployed successfully. Please download it <https://play.google.com/store/apps/details?id=com.psad_mobile|here>"
  slack(
    message: message,
    slack_url: ENV['DEV_CHANNEL_SLACK_URL'],
    success: true,
    default_payloads: []
  )
end

def changeEnv(env)
  f = File.new('../../.env', 'w')
  apiUrl = "#{env.upcase}_API_URL"
  content = "API_URL=#{ENV[apiUrl]}
ENVIRONMENT=#{env}
ENABLE_REDUX_LOGGER=#{env == 'production' ? 'false' : 'true'}"
  f.write(content)
  f.close
end